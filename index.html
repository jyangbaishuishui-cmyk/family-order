<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>å®¶åº­ç‚¹é¤å¹³å°</title>
    <meta name="description" content="å®¶äººä»¬ä¸€èµ·ç‚¹é¤çš„å®æ—¶åä½œå¹³å°">
    <meta name="theme-color" content="#4facfe">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å®¶åº­ç‚¹é¤">

    <!-- PWA Manifest -->
    <link rel="manifest" href="application/json,{
        \"name\": \"å®¶åº­ç‚¹é¤å¹³å°\",
        \"short_name\": \"å®¶åº­ç‚¹é¤\",
        \"start_url\": \"/family-order/\",
        \"display\": \"standalone\",
        \"background_color\": \"#f5f5f5\",
        \"theme_color\": \"#4facfe\",
        \"icons\": [{
            \"src\": \"/family-order/icon-192.png\",
            \"sizes\": \"192x192\",
            \"type\": \"image/png\"
        },{
            \"src\": \"/family-order/icon-512.png\",
            \"sizes\": \"512x512\",
            \"type\": \"image/png\"
        }]
    }">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Ccircle cx='96' cy='96' r='88' fill='%234facfe'/%3E%3Cpath d='M83.5 132.5h25v-25h-25v25zm0-37.5h25v-25h-25v25z' fill='%23fff'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Ccircle cx='90' cy='90' r='82' fill='%234facfe'/%3E%3Cpath d='M77 125h26v-26H77v26zm0-38h26v-26H77v26z' fill='%23fff'/%3E%3C/svg%3E">
    <style>
        :root {
            --primary: #4facfe;
            --secondary: #00f2fe;
            --success: #4caf50;
            --danger: #ff6b6b;
            --warning: #ffca28;
            --info: #2196f3;
            --dark: #343a40;
            --light: #f8f9fa;
            --gray: #6c757d;
            --border-radius: 16px;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-hover: 0 8px 24px rgba(0,0,0,0.15);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 80px;
            overscroll-behavior: none;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }
        
        /* Global Navigation */
        .global-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 28px;
            padding: 8px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            display: flex;
            gap: 8px;
            max-width: 90%;
            overflow-x: auto;
        }
        
        .nav-item {
            flex: 1;
            min-width: 70px;
            padding: 12px 8px;
            text-align: center;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
        }
        
        .nav-icon {
            font-size: 20px;
        }
        
        .global-nav::-webkit-scrollbar {
            display: none;
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
        }
        
        .date-time {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            position: relative;
        }
        
        .user-display {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0,0,0,0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .shop-display {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            margin-top: 10px;
        }
        
        .shop-name {
            font-weight: 600;
        }
        
        .change-shop-btn {
            background: rgba(0, 0, 0, 0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .change-shop-btn:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* ä¼˜åŒ–å›é€€æŒ‰é’®æ ·å¼ */
        .back-btn-global {
            position: absolute;
            left: 16px;
            top: 16px;
            background: rgba(0,0,0,0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 18px;
            color: white;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            z-index: 10;
        }
        
        .back-btn-global:hover {
            background: rgba(0,0,0,0.3);
            transform: scale(1.05);
        }
        
        .back-btn-global:active {
            transform: scale(0.95);
        }
        
        .back-btn-global:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Pages */
        .page {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Identity Page */
        .identity-page {
            text-align: center;
            padding: 40px 20px;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .identity-title {
            font-size: 28px;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .identity-instruction {
            font-size: 18px;
            margin-bottom: 30px;
            color: var(--dark);
            opacity: 0.9;
        }
        
        .identity-options {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .identity-option {
            background: white;
            border: 2px solid var(--gray);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        .identity-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }
        
        .identity-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        .identity-option.new {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-color: transparent;
        }
        
        .identity-option .option-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .identity-option .option-desc {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .identity-icon {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: white;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            border: 2px solid currentColor;
        }
        
        .new-identity-form {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 14px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.3);
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--gray);
            color: var(--dark);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(79, 172, 254, 0.4);
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Shop Selection Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .modal {
            background: white;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 22px;
        }
        
        .shop-options {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .shop-option {
            background: white;
            border: 2px solid var(--gray);
            border-radius: 16px;
            padding: 16px;
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        .shop-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }
        
        .shop-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        .shop-option .option-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .shop-option .option-desc {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .shop-icon {
            width: 36px;
            height: 36px;
            border-radius: 18px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Home Page Elements */
        .meal-tabs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .meal-tab {
            background: white;
            border-radius: var(--border-radius);
            padding: 24px 16px;
            box-shadow: var(--shadow);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .meal-tab:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }
        
        .meal-tab.active {
            box-shadow: 0 0 0 3px var(--primary), var(--shadow-hover);
        }
        
        .meal-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        
        .meal-icon {
            font-size: 36px;
            margin-bottom: 12px;
        }
        
        .meal-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .meal-status {
            font-size: 14px;
            color: var(--gray);
        }
        
        .meal-tab.order-placed .meal-status {
            color: var(--success);
            font-weight: 500;
        }
        
        /* Food Items */
        .menu-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
            justify-content: space-between;
        }
        
        .add-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .add-btn:hover {
            background: #3a9fe0;
            transform: translateY(-1px);
        }
        
        .reset-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .reset-btn:hover {
            background: #e55a1c;
            transform: translateY(-1px);
        }
        
        .categories-container {
            margin-bottom: 24px;
        }
        
        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .category-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .food-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
        }
        
        .food-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }
        
        .food-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }
        
        .food-card.selected {
            border-color: var(--primary);
            background: rgba(79, 172, 254, 0.08);
            box-shadow: 0 0 0 2px rgba(79, 172, 254, 0.3);
        }
        
        .food-emoji {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .food-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .food-price {
            font-size: 14px;
            color: var(--primary);
            font-weight: 500;
        }
        
        /* Order Summary */
        .order-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }
        
        .selected-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .selected-item {
            background: var(--primary);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .remove-item {
            background: rgba(255,255,255,0.3);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .remove-item:hover {
            background: rgba(255,255,255,0.5);
            transform: scale(1.1);
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #e9ecef;
            display: block;
        }
        
        .empty-state p {
            font-size: 16px;
            margin-top: 12px;
        }
        
        /* History */
        .history-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }
        
        .history-item {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-date {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
        }
        
        .history-meals {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .history-meal {
            flex: 1;
            min-width: 120px;
        }
        
        .meal-type {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 4px;
        }
        
        .meal-content {
            font-weight: 500;
        }
        
        .meal-content.empty {
            color: var(--gray);
            font-style: italic;
        }
        
        .orderer-info {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
            font-size: 12px;
            color: var(--gray);
        }
        
        .orderer-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            border: 1px solid currentColor;
        }
        
        /* Management Page */
        .management-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }
        
        .management-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .management-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .management-item:last-child {
            border-bottom: none;
        }
        
        .item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .item-icon {
            width: 36px;
            height: 36px;
            border-radius: 18px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .item-details {
            display: flex;
            flex-direction: column;
        }
        
        .item-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        .item-meta {
            font-size: 14px;
            color: var(--gray);
        }
        
        .item-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            background: none;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .edit-btn {
            background: var(--info);
            color: white;
        }
        
        .delete-btn {
            background: var(--danger);
            color: white;
        }
        
        .bind-btn {
            background: var(--success);
            color: white;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        /* Binding Modal */
        .binding-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .binding-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .binding-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .binding-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid var(--gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .binding-checkbox.checked {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .binding-status {
            font-size: 14px;
            color: var(--gray);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .meal-tabs {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .food-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .header {
                padding: 16px;
            }
            
            .date-time {
                font-size: 20px;
            }
            
            .global-nav {
                padding: 6px;
            }
            
            .nav-item {
                padding: 10px 6px;
                font-size: 12px;
            }
            
            .nav-icon {
                font-size: 18px;
            }
        }
        
        @media (max-width: 480px) {
            .meal-tabs {
                grid-template-columns: 1fr;
            }
            
            .header {
                padding: 12px;
            }
            
            .date-time {
                font-size: 18px;
            }
            
            .user-display {
                top: 12px;
                right: 12px;
                padding: 4px 10px;
                font-size: 14px;
            }
            
            .back-btn-global {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }
            
            .section-title {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Identity Selection Page - ALWAYS FIRST -->
        <div id="identityPage" class="page active">
            <div class="identity-page">
                <h1 class="identity-title">ğŸ  é€‰æ‹©èº«ä»½</h1>
                <p class="identity-instruction">è¿™æ˜¯ç¬¬ä¸€æ­¥ï¼Œå¿…é¡»å…ˆé€‰æ‹©èº«ä»½æ‰èƒ½ä½¿ç”¨å…¶ä»–åŠŸèƒ½</p>
                
                <div class="identity-options" id="identityOptions">
                    <!-- Identities will be populated dynamically -->
                </div>
                
                <div class="new-identity-form" id="newIdentityForm">
                    <div class="form-group">
                        <label class="form-label">æ–°èº«ä»½åç§°</label>
                        <input type="text" class="form-control" id="newIdentityName" placeholder="ä¾‹å¦‚ï¼šç™½æ°´ã€å¼ ä¸‰ã€æå››">
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-outline" id="cancelNewIdentityBtn">å–æ¶ˆ</button>
                        <button class="btn btn-primary" id="createIdentityBtn">åˆ›å»ºèº«ä»½</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Home Page -->
        <div id="homePage" class="page">
            <div class="header">
                <button class="back-btn-global" id="backBtnGlobal">ğŸ‘¤</button>
                <div class="date-time" id="dateTimeDisplay">2023å¹´5æœˆ15æ—¥ æ˜ŸæœŸä¸€</div>
                <div class="user-display" id="userDisplay">
                    <div class="identity-icon" id="userIcon">ğŸ‘¤</div>
                    <span id="userNameDisplay">ç”¨æˆ·</span>
                </div>
                <div class="shop-display">
                    <span class="shop-name" id="currentShopName">åº—é“ºåç§°</span>
                    <button class="change-shop-btn" id="changeShopBtn">â†»</button>
                </div>
            </div>
            
            <h2 class="section-title">ğŸš ä»Šæ—¥é¤é£Ÿ</h2>
            
            <div class="meal-tabs" id="mealTabs">
                <div class="meal-tab" data-meal="breakfast">
                    <div class="meal-icon">ğŸŒ…</div>
                    <div class="meal-name">æ—©é¤</div>
                    <div class="meal-status">æœªç‚¹é¤</div>
                </div>
                <div class="meal-tab" data-meal="lunch">
                    <div class="meal-icon">â˜€ï¸</div>
                    <div class="meal-name">åˆé¤</div>
                    <div class="meal-status">æœªç‚¹é¤</div>
                </div>
                <div class="meal-tab" data-meal="dinner">
                    <div class="meal-icon">ğŸŒ‡</div>
                    <div class="meal-name">æ™šé¤</div>
                    <div class="meal-status">æœªç‚¹é¤</div>
                </div>
                <div class="meal-tab" data-meal="night">
                    <div class="meal-icon">ğŸŒ™</div>
                    <div class="meal-name">å¤œå®µ</div>
                    <div class="meal-status">æœªç‚¹é¤</div>
                </div>
            </div>
            
            <div class="history-section">
                <h2 class="section-title">ğŸ“Š ç‚¹é¤å†å²</h2>
                <div id="historyList">
                    <div class="empty-state">
                        <div>ğŸ“…</div>
                        <p>æš‚æ— ç‚¹é¤å†å²<br>å¼€å§‹ä»Šå¤©çš„ç‚¹é¤å§</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Order Page -->
        <div id="orderPage" class="page">
            <div class="header">
                <button class="back-btn-global" id="backBtnGlobalOrder">â†</button>
                <div class="date-time" id="orderDateTime">2023å¹´5æœˆ15æ—¥</div>
                <div class="user-display" id="orderUserDisplay">
                    <div class="identity-icon" id="orderUserIcon">ğŸ‘¤</div>
                    <span id="orderUserName">ç”¨æˆ·</span>
                </div>
            </div>
            
            <div class="menu-section">
                <h2 class="section-title" id="currentMealTitle">ğŸŒ… æ—©é¤</h2>
                <div id="categoriesContainer" class="categories-container">
                    <!-- Categories will be dynamically added here -->
                </div>
            </div>
            
            <div class="order-section">
                <h2 class="section-title">âœ… å·²é€‰èœå“</h2>
                <div class="selected-items" id="selectedItems">
                    <div class="empty-state" style="padding: 20px; margin: 0;">
                        <div>ğŸ›’</div>
                        <p>æš‚æœªé€‰æ‹©èœå“<br>ç‚¹å‡»ä¸Šæ–¹èœå“æ·»åŠ </p>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-outline" id="clearSelectionBtn">æ¸…ç©ºé€‰æ‹©</button>
                    <button class="btn btn-primary" id="submitOrderBtn" disabled>ç¡®è®¤ç‚¹é¤</button>
                </div>
            </div>
        </div>
        
        <!-- Management Page -->
        <div id="managementPage" class="page">
            <div class="header">
                <button class="back-btn-global" id="backBtnGlobalManagement">â†</button>
                <div class="date-time">ç®¡ç†</div>
                <div class="user-display" id="managementUserDisplay">
                    <div class="identity-icon" id="managementUserIcon">ğŸ‘¤</div>
                    <span id="managementUserName">ç”¨æˆ·</span>
                </div>
            </div>
            
            <div class="management-section">
                <h2 class="section-title">ğŸ‘¤ èº«ä»½ç®¡ç†</h2>
                <div class="management-list" id="identityManagementList">
                    <!-- Identities will be populated dynamically -->
                </div>
                <div class="form-actions" style="margin-top: 20px;">
                    <button class="btn btn-primary" id="addIdentityBtn">æ·»åŠ èº«ä»½</button>
                </div>
            </div>
            
            <div class="management-section">
                <h2 class="section-title">ğŸª åº—é“ºç®¡ç†</h2>
                <div class="management-list" id="shopManagementList">
                    <!-- Shops will be populated dynamically -->
                </div>
                <div class="form-actions" style="margin-top: 20px;">
                    <button class="btn btn-primary" id="addShopBtn">æ·»åŠ åº—é“º</button>
                </div>
            </div>
            
            <div class="management-section">
                <h2 class="section-title">ğŸ½ï¸ èœå“ç®¡ç†</h2>
                <div class="management-list" id="foodManagementList">
                    <!-- Foods will be populated dynamically -->
                </div>
                <div class="form-actions" style="margin-top: 20px;">
                    <button class="btn btn-primary" id="addFoodBtn">æ·»åŠ èœå“</button>
                </div>
            </div>
            
            <div class="management-section">
                <h2 class="section-title">ğŸ”” ç»‘å®šè®¾ç½®</h2>
                <div class="management-list" id="bindingManagementList">
                    <!-- Bindings will be populated dynamically -->
                </div>
                <div class="form-actions" style="margin-top: 20px;">
                    <button class="btn btn-primary" id="manageBindingsBtn">ç®¡ç†ç»‘å®š</button>
                </div>
            </div>
            
            <div class="management-section">
                <h2 class="section-title">ğŸ§¹ æ•°æ®ç®¡ç†</h2>
                <div class="action-buttons">
                    <button class="btn btn-outline" id="exportDataBtn">å¯¼å‡ºæ•°æ®</button>
                    <button class="btn btn-outline" id="importDataBtn">å¯¼å…¥æ•°æ®</button>
                    <button class="btn btn-danger" id="resetAllDataBtn">é‡ç½®æ‰€æœ‰æ•°æ®</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Shop Selection Modal -->
    <div class="modal-overlay" id="shopModal">
        <div class="modal">
            <h3 class="modal-title">ğŸª é€‰æ‹©åº—é“º</h3>
            <div class="shop-options" id="shopOptions">
                <!-- Shops will be populated dynamically -->
            </div>
            <div class="form-actions">
                <button class="btn btn-outline" id="cancelShopBtn">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="createShopBtn">åˆ›å»ºæ–°åº—é“º</button>
            </div>
        </div>
    </div>
    
    <!-- Create Shop Modal -->
    <div class="modal-overlay" id="createShopModal">
        <div class="modal">
            <h3 class="modal-title">åˆ›å»ºæ–°åº—é“º</h3>
            <div class="form-group">
                <label class="form-label">åº—é“ºåç§°</label>
                <input type="text" class="form-control" id="newShopName" placeholder="ä¾‹å¦‚ï¼šçˆ¸å¦ˆå®¶ã€å§å§å®¶ã€ä½³ä½³å®¶">
            </div>
            <div class="form-actions">
                <button class="btn btn-outline" id="cancelCreateShopBtn">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirmCreateShopBtn">åˆ›å»ºåº—é“º</button>
            </div>
        </div>
    </div>
    
    <!-- Binding Modal -->
    <div class="modal-overlay" id="bindingModal">
        <div class="modal">
            <h3 class="modal-title">ğŸ”” ç»‘å®šè®¾ç½®</h3>
            <p style="margin-bottom: 16px; color: var(--gray);">ç»‘å®šåï¼Œå½“æœ‰äººä¿®æ”¹æˆ–ç¡®å®šç‚¹é¤æ—¶ï¼Œæ‚¨ä¼šæ”¶åˆ°é€šçŸ¥</p>
            <div class="binding-list" id="bindingList">
                <!-- Bindings will be populated dynamically -->
            </div>
            <div class="form-actions">
                <button class="btn btn-outline" id="cancelBindingBtn">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="saveBindingBtn">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>
    
    <!-- Global Navigation -->
    <div class="global-nav" id="globalNav">
        <div class="nav-item active" data-page="homePage">
            <div class="nav-icon">ğŸ </div>
            <div>é¦–é¡µ</div>
        </div>
        <div class="nav-item" data-page="orderPage" style="display: none;" id="orderNavTab">
            <div class="nav-icon">ğŸ½ï¸</div>
            <div>ç‚¹é¤</div>
        </div>
        <div class="nav-item" data-page="managementPage">
            <div class="nav-icon">âš™ï¸</div>
            <div>ç®¡ç†</div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // DOM Elements
        const identityPage = document.getElementById('identityPage');
        const homePage = document.getElementById('homePage');
        const orderPage = document.getElementById('orderPage');
        const managementPage = document.getElementById('managementPage');
        const identityOptions = document.getElementById('identityOptions');
        const newIdentityForm = document.getElementById('newIdentityForm');
        const newIdentityName = document.getElementById('newIdentityName');
        const createIdentityBtn = document.getElementById('createIdentityBtn');
        const cancelNewIdentityBtn = document.getElementById('cancelNewIdentityBtn');
        const shopModal = document.getElementById('shopModal');
        const shopOptions = document.getElementById('shopOptions');
        const createShopBtn = document.getElementById('createShopBtn');
        const cancelShopBtn = document.getElementById('cancelShopBtn');
        const createShopModal = document.getElementById('createShopModal');
        const newShopName = document.getElementById('newShopName');
        const cancelCreateShopBtn = document.getElementById('cancelCreateShopBtn');
        const confirmCreateShopBtn = document.getElementById('confirmCreateShopBtn');
        const dateTimeDisplay = document.getElementById('dateTimeDisplay');
        const mealTabs = document.getElementById('mealTabs');
        const historyList = document.getElementById('historyList');
        const userDisplay = document.getElementById('userDisplay');
        const userIcon = document.getElementById('userIcon');
        const userNameDisplay = document.getElementById('userNameDisplay');
        const currentShopName = document.getElementById('currentShopName');
        const changeShopBtn = document.getElementById('changeShopBtn');
        const orderDateTime = document.getElementById('orderDateTime');
        const currentMealTitle = document.getElementById('currentMealTitle');
        const categoriesContainer = document.getElementById('categoriesContainer');
        const selectedItems = document.getElementById('selectedItems');
        const clearSelectionBtn = document.getElementById('clearSelectionBtn');
        const submitOrderBtn = document.getElementById('submitOrderBtn');
        const orderUserDisplay = document.getElementById('orderUserDisplay');
        const orderUserIcon = document.getElementById('orderUserIcon');
        const orderUserName = document.getElementById('orderUserName');
        const managementUserDisplay = document.getElementById('managementUserDisplay');
        const managementUserIcon = document.getElementById('managementUserIcon');
        const managementUserName = document.getElementById('managementUserName');
        const identityManagementList = document.getElementById('identityManagementList');
        const shopManagementList = document.getElementById('shopManagementList');
        const foodManagementList = document.getElementById('foodManagementList');
        const bindingManagementList = document.getElementById('bindingManagementList');
        const addIdentityBtn = document.getElementById('addIdentityBtn');
        const addShopBtn = document.getElementById('addShopBtn');
        const addFoodBtn = document.getElementById('addFoodBtn');
        const manageBindingsBtn = document.getElementById('manageBindingsBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const resetAllDataBtn = document.getElementById('resetAllDataBtn');
        const backBtnGlobal = document.getElementById('backBtnGlobal');
        const backBtnGlobalOrder = document.getElementById('backBtnGlobalOrder');
        const backBtnGlobalManagement = document.getElementById('backBtnGlobalManagement');
        const orderNavTab = document.getElementById('orderNavTab');
        const globalNav = document.getElementById('globalNav');
        const notification = document.getElementById('notification');
        const bindingModal = document.getElementById('bindingModal');
        const bindingList = document.getElementById('bindingList');
        const cancelBindingBtn = document.getElementById('cancelBindingBtn');
        const saveBindingBtn = document.getElementById('saveBindingBtn');
        
        // App State
        let currentUserId = null;
        let currentUser = null;
        let currentShopId = null;
        let currentShop = null;
        let currentMealType = 'breakfast';
        let selectedFoods = [];
        let currentPage = 'identityPage';
        
        // Initialize app data from localStorage
        let identities = JSON.parse(localStorage.getItem('identities')) || [
            { id: 'bai', name: 'ç™½æ°´', color: '#4facfe' }
        ];
        
        let shops = JSON.parse(localStorage.getItem('shops')) || [
            { id: 'parents', name: 'çˆ¸å¦ˆå®¶', color: '#4facfe' },
            { id: 'sister', name: 'å§å§å®¶', color: '#ff6b6b' },
            { id: 'jiajia', name: 'ä½³ä½³å®¶', color: '#43e97b' }
        ];
        
        let categories = JSON.parse(localStorage.getItem('categories')) || {};
        let foods = JSON.parse(localStorage.getItem('foods')) || {};
        let orders = JSON.parse(localStorage.getItem('orders')) || {};
        let bindings = JSON.parse(localStorage.getItem('bindings')) || {};
        
        const today = new Date().toISOString().split('T')[0];
        
        // Initialize default categories and foods for each shop
        shops.forEach(shop => {
            if (!categories[shop.id]) {
                categories[shop.id] = [
                    { id: generateId(), name: 'å¤§è¤', order: 1 },
                    { id: generateId(), name: 'å°è¤', order: 2 },
                    { id: generateId(), name: 'ç´ èœ', order: 3 },
                    { id: generateId(), name: 'æ±¤ç±»', order: 4 },
                    { id: generateId(), name: 'ç”œå“', order: 5 },
                    { id: generateId(), name: 'å°åƒ', order: 6 },
                    { id: generateId(), name: 'é¥®æ–™', order: 7 }
                ];
            }
            
            if (!foods[shop.id]) {
                const shopCategories = categories[shop.id];
                foods[shop.id] = [
                    { id: generateId(), name: 'çº¢çƒ§è‚‰', categoryId: shopCategories[0].id, emoji: 'ğŸ–', price: 28 },
                    { id: generateId(), name: 'æ¸…è’¸é±¼', categoryId: shopCategories[0].id, emoji: 'ğŸŸ', price: 32 },
                    { id: generateId(), name: 'å®«ä¿é¸¡ä¸', categoryId: shopCategories[1].id, emoji: 'ğŸ—', price: 25 },
                    { id: generateId(), name: 'è¥¿çº¢æŸ¿ç‚’è›‹', categoryId: shopCategories[2].id, emoji: 'ğŸ³', price: 18 },
                    { id: generateId(), name: 'é’èœ', categoryId: shopCategories[2].id, emoji: 'ğŸ¥¬', price: 12 },
                    { id: generateId(), name: 'ç´«èœè›‹èŠ±æ±¤', categoryId: shopCategories[3].id, emoji: 'ğŸ²', price: 10 },
                    { id: generateId(), name: 'å†°æ·‡æ·‹', categoryId: shopCategories[4].id, emoji: 'ğŸ¦', price: 15 },
                    { id: generateId(), name: 'æ°´æœæ‹¼ç›˜', categoryId: shopCategories[4].id, emoji: 'ğŸ“', price: 22 },
                    { id: generateId(), name: 'æ˜¥å·', categoryId: shopCategories[5].id, emoji: 'ğŸ¥ ', price: 16 },
                    { id: generateId(), name: 'å¯ä¹', categoryId: shopCategories[6].id, emoji: 'ğŸ¥¤', price: 8 },
                    { id: generateId(), name: 'è±†æµ†', categoryId: shopCategories[6].id, emoji: 'ğŸ¥›', price: 6 }
                ];
            }
        });
        
        // Initialize bindings for each identity
        identities.forEach(identity => {
            if (!bindings[identity.id]) {
                bindings[identity.id] = [];
            }
        });
        
        // Save initial data
        saveIdentities();
        saveShops();
        saveCategories();
        saveFoods();
        saveBindings();
        
        // Initialize the app
        function initApp() {
            console.log('Application starting...');
            
            // ALWAYS start at identity page
            showPage('identityPage');
            renderIdentityOptions();
            setupEventListeners();
            updateDateTime();
            setupBackButtons(); // ä¸“é—¨è®¾ç½®å›é€€æŒ‰é’®
            
            console.log('Application initialized');
        }
        
        // ä¼˜åŒ–å›é€€æŒ‰é’®åŠŸèƒ½
        function setupBackButtons() {
            console.log('Setting up back buttons...');
            
            // é¦–é¡µå›é€€æŒ‰é’® - è¿”å›èº«ä»½é€‰æ‹©
            if (backBtnGlobal) {
                backBtnGlobal.addEventListener('click', function(e) {
                    e.stopPropagation();
                    console.log('Home back button clicked');
                    
                    if (currentPage === 'homePage') {
                        showPage('identityPage');
                    }
                });
                
                // æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
                backBtnGlobal.addEventListener('touchstart', function(e) {
                    e.stopPropagation();
                    this.style.transform = 'scale(0.95)';
                });
                
                backBtnGlobal.addEventListener('touchend', function(e) {
                    e.stopPropagation();
                    this.style.transform = 'scale(1)';
                    if (currentPage === 'homePage') {
                        showPage('identityPage');
                    }
                });
            }
            
            // ç‚¹é¤é¡µé¢å›é€€æŒ‰é’® - è¿”å›é¦–é¡µ
            if (backBtnGlobalOrder) {
                backBtnGlobalOrder.addEventListener('click', function(e) {
                    e.stopPropagation();
                    console.log('Order back button clicked');
                    
                    showPage('homePage');
                    updateMealStatus();
                    loadHistory();
                });
                
                // æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
                backBtnGlobalOrder.addEventListener('touchstart', function(e) {
                    e.stopPropagation();
                    this.style.transform = 'scale(0.95)';
                });
                
                backBtnGlobalOrder.addEventListener('touchend', function(e) {
                    e.stopPropagation();
                    this.style.transform = 'scale(1)';
                    showPage('homePage');
                    updateMealStatus();
                    loadHistory();
                });
            }
            
            // ç®¡ç†é¡µé¢å›é€€æŒ‰é’® - è¿”å›é¦–é¡µ
            if (backBtnGlobalManagement) {
                backBtnGlobalManagement.addEventListener('click', function(e) {
                    e.stopPropagation();
                    console.log('Management back button clicked');
                    
                    showPage('homePage');
                });
                
                // æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
                backBtnGlobalManagement.addEventListener('touchstart', function(e) {
                    e.stopPropagation();
                    this.style.transform = 'scale(0.95)';
                });
                
                backBtnGlobalManagement.addEventListener('touchend', function(e) {
                    e.stopPropagation();
                    this.style.transform = 'scale(1)';
                    showPage('homePage');
                });
            }
            
            console.log('Back buttons setup completed');
        }
        
        // Render identity options
        function renderIdentityOptions() {
            identityOptions.innerHTML = '';
            
            // Add existing identities
            identities.forEach(identity => {
                const identityOption = document.createElement('div');
                identityOption.className = 'identity-option';
                identityOption.innerHTML = `
                    <div class="option-title">
                        <div class="identity-icon" style="color: ${identity.color}; border-color: ${identity.color};">
                            ${identity.name.charAt(0)}
                        </div>
                        ${identity.name}
                    </div>
                    <div class="option-desc">é€‰æ‹©æ­¤èº«ä»½ç‚¹é¤</div>
                `;
                identityOption.addEventListener('click', function() {
                    selectIdentity(identity);
                });
                identityOptions.appendChild(identityOption);
            });
            
            // Add "Create new" option
            const newOption = document.createElement('div');
            newOption.className = 'identity-option new';
            newOption.innerHTML = `
                <div class="option-title">
                    <div class="identity-icon" style="color: white; border-color: white;">
                        âœš
                    </div>
                    åˆ›å»ºæ–°èº«ä»½
                </div>
                <div class="option-desc">æ·»åŠ æ–°çš„èº«ä»½</div>
            `;
            newOption.addEventListener('click', function() {
                toggleNewIdentityForm();
            });
            identityOptions.appendChild(newOption);
        }
        
        // Toggle new identity form
        function toggleNewIdentityForm() {
            if (newIdentityForm.style.display === 'block') {
                newIdentityForm.style.display = 'none';
                newIdentityName.value = '';
            } else {
                newIdentityForm.style.display = 'block';
                newIdentityName.focus();
            }
        }
        
        // Select identity
        function selectIdentity(identity) {
            currentUser = identity;
            currentUserId = identity.id;
            
            console.log(`Identity selected: ${identity.name} (${identity.id})`);
            
            // Show shop selection modal
            showShopModal();
        }
        
        // Show shop selection modal
        function showShopModal() {
            renderShopOptions();
            shopModal.style.display = 'flex';
        }
        
        // Hide shop selection modal
        function hideShopModal() {
            shopModal.style.display = 'none';
        }
        
        // Render shop options in modal
        function renderShopOptions() {
            shopOptions.innerHTML = '';
            
            shops.forEach(shop => {
                const shopOption = document.createElement('div');
                shopOption.className = 'shop-option';
                shopOption.innerHTML = `
                    <div class="option-title">
                        <div class="shop-icon" style="background-color: ${shop.color}; color: white;">
                            ${shop.name.charAt(0)}
                        </div>
                        ${shop.name}
                    </div>
                    <div class="option-desc">åœ¨ ${shop.name} ç‚¹é¤</div>
                `;
                shopOption.addEventListener('click', function() {
                    selectShop(shop);
                    hideShopModal();
                });
                shopOptions.appendChild(shopOption);
            });
        }
        
        // Select shop
        function selectShop(shop) {
            currentShop = shop;
            currentShopId = shop.id;
            
            console.log(`Shop selected: ${shop.name} (${shop.id}) for user ${currentUser.name}`);
            showPage('homePage');
            renderUserDisplay();
            updateMealStatus();
            loadHistory();
        }
        
        // Render user display
        function renderUserDisplay() {
            if (!currentUser || !currentShop) return;
            
            // Update user displays
            userIcon.textContent = currentUser.name.charAt(0);
            userIcon.style.color = currentUser.color;
            userIcon.style.borderColor = currentUser.color;
            userNameDisplay.textContent = currentUser.name;
            currentShopName.textContent = currentShop.name;
            
            orderUserIcon.textContent = currentUser.name.charAt(0);
            orderUserIcon.style.color = currentUser.color;
            orderUserIcon.style.borderColor = currentUser.color;
            orderUserName.textContent = currentUser.name;
            
            managementUserIcon.textContent = currentUser.name.charAt(0);
            managementUserIcon.style.color = currentUser.color;
            managementUserIcon.style.borderColor = currentUser.color;
            managementUserName.textContent = currentUser.name;
        }
        
        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            
            dateTimeDisplay.textContent = dateStr;
            orderDateTime.textContent = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;
        }
        
        // Update meal status display (ordered or not)
        function updateMealStatus() {
            if (!currentUserId || !currentShopId) return;
            
            // ä¿®å¤ï¼šæ£€æŸ¥å½“å‰ç”¨æˆ·çš„è®¢å•çŠ¶æ€
            const orderKey = `${today}-${currentShopId}-${currentUserId}`;
            const userOrders = orders[orderKey] || {};

            document.querySelectorAll('.meal-tab').forEach(tab => {
                const mealType = tab.dataset.meal;
                const statusElem = tab.querySelector('.meal-status');

                if (userOrders[mealType] && userOrders[mealType].foods && userOrders[mealType].foods.length > 0) {
                    tab.classList.add('order-placed');
                    statusElem.textContent = 'å·²ç‚¹é¤';
                } else {
                    tab.classList.remove('order-placed');
                    statusElem.textContent = 'æœªç‚¹é¤';
                }
            });
        }
        
        // Load history for display
        function loadHistory() {
            if (!currentUserId || !currentShopId) return;

            // ä¿®å¤ï¼šè·å–å½“å‰åº—é“ºçš„æ‰€æœ‰ç”¨æˆ·è®¢å•
            const shopOrders = {};
            Object.keys(orders).forEach(key => {
                if (key.includes(`-${currentShopId}-`)) {
                    const parts = key.split('-');
                    const date = parts[0];
                    const shopId = parts[1];
                    const userId = parts[2];
                    
                    if (!shopOrders[date]) {
                        shopOrders[date] = {};
                    }
                    shopOrders[date][userId] = orders[key];
                }
            });

            const historyKeys = Object.keys(shopOrders).sort((a, b) => new Date(b) - new Date(a)).slice(0, 7);

            if (historyKeys.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <div>ğŸ“…</div>
                        <p>æš‚æ— ç‚¹é¤å†å²<br>å¼€å§‹ä»Šå¤©çš„ç‚¹é¤å§</p>
                    </div>
                `;
                return;
            }

            let historyHTML = '';

            historyKeys.forEach(dateStr => {
                const date = new Date(dateStr);
                const dateDisplay = date.toLocaleDateString('zh-CN', {
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });

                const dailyUserOrders = shopOrders[dateStr] || {};
                
                historyHTML += `
                    <div class="history-item">
                        <div class="history-date">${dateDisplay}</div>
                        <div class="history-meals">
                            <div class="history-meal">
                                <div class="meal-type">æ—©é¤</div>
                                ${renderMealHistory(dailyUserOrders, 'breakfast')}
                            </div>
                            <div class="history-meal">
                                <div class="meal-type">åˆé¤</div>
                                ${renderMealHistory(dailyUserOrders, 'lunch')}
                            </div>
                            <div class="history-meal">
                                <div class="meal-type">æ™šé¤</div>
                                ${renderMealHistory(dailyUserOrders, 'dinner')}
                            </div>
                            <div class="history-meal">
                                <div class="meal-type">å¤œå®µ</div>
                                ${renderMealHistory(dailyUserOrders, 'night')}
                            </div>
                        </div>
                    </div>
                `;
            });

            historyList.innerHTML = historyHTML;
        }

        // æ–°å¢è¾…åŠ©å‡½æ•°æ¥æ¸²æŸ“é¤é£Ÿå†å²
        function renderMealHistory(dailyUserOrders, mealType) {
            let html = '';
            let hasOrders = false;
            
            // æ”¶é›†è¯¥é¤æ¬¡çš„æ‰€æœ‰ç”¨æˆ·è®¢å•
            const mealOrders = [];
            Object.keys(dailyUserOrders).forEach(userId => {
                const userOrder = dailyUserOrders[userId][mealType];
                if (userOrder && userOrder.foods && userOrder.foods.length > 0) {
                    mealOrders.push({
                        userId: userId,
                        foods: userOrder.foods
                    });
                    hasOrders = true;
                }
            });
            
            if (!hasOrders) {
                return `
                    <div class="meal-content empty">æœªç‚¹é¤</div>
                `;
            }
            
            // æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·çš„è®¢å•
            mealOrders.forEach(order => {
                const foodNames = order.foods.map(item => item.name).join(', ');
                html += `
                    <div class="meal-content">
                        ${foodNames}
                        <div class="orderer-info">
                            <div class="orderer-icon" style="color: ${getIdentityColor(order.userId)}; border-color: ${getIdentityColor(order.userId)};">
                                ${getIdentityInitial(order.userId)}
                            </div>
                            ${getIdentityName(order.userId)}
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        // Helper functions for identity data
        function getIdentityColor(identityId) {
            const identity = identities.find(i => i.id === identityId);
            return identity ? identity.color : '#4facfe';
        }
        
        function getIdentityInitial(identityId) {
            const identity = identities.find(i => i.id === identityId);
            return identity ? identity.name.charAt(0) : '?';
        }
        
        function getIdentityName(identityId) {
            const identity = identities.find(i => i.id === identityId);
            return identity ? identity.name : 'æœªçŸ¥';
        }
        
        // Show order page for selected meal
        function showOrderPage() {
            if (!currentUser || !currentShop) {
                console.error('Cannot show order page without identity and shop');
                showPage('identityPage');
                return;
            }
            
            showPage('orderPage');
            
            // Update title based on meal type
            const mealTitles = {
                'breakfast': 'ğŸŒ… æ—©é¤',
                'lunch': 'â˜€ï¸ åˆé¤',
                'dinner': 'ğŸŒ‡ æ™šé¤',
                'night': 'ğŸŒ™ å¤œå®µ'
            };
            
            currentMealTitle.textContent = mealTitles[currentMealType];
            renderUserDisplay();
            
            // ä¿®å¤ï¼šåªåŠ è½½å½“å‰ç”¨æˆ·çš„è®¢å•
            const orderKey = `${today}-${currentShopId}-${currentUserId}`;
            const userOrders = orders[orderKey] || {};
            const currentOrder = userOrders[currentMealType] || {};

            selectedFoods = currentOrder.foods || [];
            
            // Render categories and foods
            renderCategories();
            updateSelectedItemsDisplay();
        }
        
        // Render categories
        function renderCategories() {
            if (!currentShopId) return;
            
            const shopCategories = categories[currentShopId] || [];
            const shopFoods = foods[currentShopId] || [];
            
            // Sort categories by order
            shopCategories.sort((a, b) => a.order - b.order);
            
            // Filter categories that have at least one food
            const categoriesWithFoods = shopCategories.filter(category => 
                shopFoods.some(food => food.categoryId === category.id)
            );
            
            if (categoriesWithFoods.length === 0) {
                categoriesContainer.innerHTML = `
                    <div class="empty-state">
                        <div>ğŸ·ï¸</div>
                        <p>æš‚æ— èœå“åˆ†ç±»<br>è¯·å…ˆåˆ›å»ºåˆ†ç±»å’Œèœå“</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            categoriesWithFoods.forEach(category => {
                const categoryFoods = shopFoods.filter(food => food.categoryId === category.id);
                if (categoryFoods.length > 0) {
                    html += `
                        <div class="category-header">
                            <div class="category-title">
                                <span>ğŸ·ï¸</span> ${category.name}
                            </div>
                        </div>
                        <div class="food-grid" data-category-id="${category.id}">
                            ${categoryFoods.map(food => {
                                const isSelected = selectedFoods.some(item => item.id === food.id);
                                return `
                                    <div class="food-card ${isSelected ? 'selected' : ''}" data-id="${food.id}">
                                        <div class="food-emoji">${food.emoji}</div>
                                        <div class="food-name">${food.name}</div>
                                        <div class="food-price">${food.price}ç§¯åˆ†</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
            });
            
            categoriesContainer.innerHTML = html;
            
            // Add click listeners to food cards
            document.querySelectorAll('.food-card').forEach(card => {
                card.addEventListener('click', function() {
                    const foodId = this.dataset.id;
                    toggleFoodSelection(foodId);
                });
            });
        }
        
        // Toggle food selection
        function toggleFoodSelection(foodId) {
            if (!currentShopId) return;
            
            const shopFoods = foods[currentShopId] || [];
            const food = shopFoods.find(item => item.id === foodId);
            if (!food) return;
            
            const index = selectedFoods.findIndex(item => item.id === foodId);
            
            if (index === -1) {
                // Add to selection
                selectedFoods.push({
                    id: food.id,
                    name: food.name,
                    price: food.price,
                    emoji: food.emoji
                });
                showNotification(`${food.name} å·²åŠ å…¥`);
            } else {
                // Remove from selection
                selectedFoods.splice(index, 1);
                showNotification(`${food.name} å·²ç§»é™¤`);
            }
            
            updateSelectedItemsDisplay();
            renderCategories(); // Refresh to update selected state
        }
        
        // Update selected items display
        function updateSelectedItemsDisplay() {
            if (selectedFoods.length === 0) {
                selectedItems.innerHTML = `
                    <div class="empty-state" style="padding: 20px; margin: 0;">
                        <div>ğŸ›’</div>
                        <p>æš‚æœªé€‰æ‹©èœå“<br>ç‚¹å‡»ä¸Šæ–¹èœå“æ·»åŠ </p>
                    </div>
                `;
                submitOrderBtn.disabled = true;
                return;
            }
            
            selectedItems.innerHTML = selectedFoods.map(food => `
                <div class="selected-item" data-id="${food.id}">
                    ${food.emoji} ${food.name} (${food.price}ç§¯åˆ†)
                    <span class="remove-item">Ã—</span>
                </div>
            `).join('');
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-item').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const item = this.closest('.selected-item');
                    const foodId = item.dataset.id;
                    toggleFoodSelection(foodId);
                });
            });
            
            submitOrderBtn.disabled = false;
        }
        
        // Submit order
        function submitOrder() {
            if (selectedFoods.length === 0) {
                showNotification('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§é£Ÿç‰©', 'error');
                return;
            }
            
            if (!currentUserId || !currentShopId) {
                showNotification('è¯·å…ˆé€‰æ‹©èº«ä»½å’Œåº—é“º', 'error');
                return;
            }

            // ä¿®å¤ï¼šåˆ›å»ºåŸºäºèº«ä»½å’Œåº—é“ºçš„å”¯ä¸€è®¢å•é”®
            const orderKey = `${today}-${currentShopId}-${currentUserId}`;
            const mealKey = `${currentMealType}`;
            
            // ä¿å­˜å½“å‰ç”¨æˆ·çš„è®¢å•ï¼Œä¸å½±å“å…¶ä»–ç”¨æˆ·
            if (!orders[orderKey]) {
                orders[orderKey] = {};
            }
            
            orders[orderKey][mealKey] = {
                userId: currentUserId,
                foods: selectedFoods,
                timestamp: new Date().toISOString()
            };
            
            saveOrders();

            // Send notifications to bound users
            sendOrderNotifications(currentMealType, selectedFoods, false);

            // Update UI
            showNotification(`âœ… ${currentMealTitle.textContent}ç‚¹é¤æˆåŠŸï¼`);

            // Return to home page after delay
            setTimeout(() => {
                showPage('homePage');
                updateMealStatus();
                loadHistory();
            }, 1500);
        }
        
        // Send notifications to users bound to this shop
        function sendOrderNotifications(mealType, foods, isModification = false) {
            if (!currentShopId || !currentUser) return;
            
            // Find all users bound to this shop
            Object.keys(bindings).forEach(identityId => {
                // Skip current user
                if (identityId === currentUserId) return;
                
                // Check if this identity is bound to current shop
                if (bindings[identityId].includes(currentShopId)) {
                    const actionText = isModification ? 'ä¿®æ”¹äº†' : 'ç‚¹äº†';
                    const foodNames = foods.map(food => food.name).join(', ');
                    const message = `${currentUser.name} åœ¨ ${currentShop.name} ${actionText} ${mealType}: ${foodNames}`;
                    
                    // In a real app, this would send a push notification
                    // For this demo, we'll just log it
                    console.log(`å‘é€é€šçŸ¥ç»™ ${getIdentityName(identityId)}: ${message}`);
                    
                    // å¯ä»¥é€‰æ‹©åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºé€šçŸ¥
                    // showNotification(`ğŸ”” ${getIdentityName(identityId)} æ”¶åˆ°é€šçŸ¥: ${message}`);
                }
            });
        }
        
        // Create new identity
        function createIdentity() {
            const name = newIdentityName.value.trim();
            if (!name) {
                showNotification('èº«ä»½åç§°ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            // Check if identity already exists
            if (identities.some(i => i.name.toLowerCase() === name.toLowerCase())) {
                showNotification('è¯¥èº«ä»½å·²å­˜åœ¨', 'error');
                return;
            }
            
            // Create new identity
            const newIdentity = {
                id: generateId(),
                name: name,
                color: getRandomColor()
            };
            
            identities.push(newIdentity);
            bindings[newIdentity.id] = []; // Initialize empty bindings
            saveIdentities();
            saveBindings();
            
            // Reset form
            newIdentityName.value = '';
            newIdentityForm.style.display = 'none';
            
            // ä¿®å¤ï¼šé‡æ–°æ¸²æŸ“èº«ä»½é€‰æ‹©ç•Œé¢
            renderIdentityOptions();
            
            // Select the new identity
            selectIdentity(newIdentity);
            
            showNotification(`èº«ä»½ "${name}" åˆ›å»ºæˆåŠŸï¼`);
        }
        
        // Create new shop
        function createShop() {
            const name = newShopName.value.trim();
            if (!name) {
                showNotification('åº—é“ºåç§°ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            // Check if shop already exists
            if (shops.some(s => s.name.toLowerCase() === name.toLowerCase())) {
                showNotification('è¯¥åº—é“ºå·²å­˜åœ¨', 'error');
                return;
            }
            
            // Create new shop
            const newShop = {
                id: generateId(),
                name: name,
                color: getRandomColor()
            };
            
            shops.push(newShop);
            saveShops();
            
            // Initialize categories and foods for this shop
            categories[newShop.id] = [
                { id: generateId(), name: 'å¤§è¤', order: 1 },
                { id: generateId(), name: 'å°è¤', order: 2 },
                { id: generateId(), name: 'ç´ èœ', order: 3 },
                { id: generateId(), name: 'æ±¤ç±»', order: 4 },
                { id: generateId(), name: 'ç”œå“', order: 5 },
                { id: generateId(), name: 'å°åƒ', order: 6 },
                { id: generateId(), name: 'é¥®æ–™', order: 7 }
            ];
            
            const shopCategories = categories[newShop.id];
            foods[newShop.id] = [
                { id: generateId(), name: 'çº¢çƒ§è‚‰', categoryId: shopCategories[0].id, emoji: 'ğŸ–', price: 28 },
                { id: generateId(), name: 'æ¸…è’¸é±¼', categoryId: shopCategories[0].id, emoji: 'ğŸŸ', price: 32 },
                { id: generateId(), name: 'å®«ä¿é¸¡ä¸', categoryId: shopCategories[1].id, emoji: 'ğŸ—', price: 25 },
                { id: generateId(), name: 'è¥¿çº¢æŸ¿ç‚’è›‹', categoryId: shopCategories[2].id, emoji: 'ğŸ³', price: 18 },
                { id: generateId(), name: 'é’èœ', categoryId: shopCategories[2].id, emoji: 'ğŸ¥¬', price: 12 },
                { id: generateId(), name: 'ç´«èœè›‹èŠ±æ±¤', categoryId: shopCategories[3].id, emoji: 'ğŸ²', price: 10 },
                { id: generateId(), name: 'å†°æ·‡æ·‹', categoryId: shopCategories[4].id, emoji: 'ğŸ¦', price: 15 },
                { id: generateId(), name: 'æ°´æœæ‹¼ç›˜', categoryId: shopCategories[4].id, emoji: 'ğŸ“', price: 22 },
                { id: generateId(), name: 'æ˜¥å·', categoryId: shopCategories[5].id, emoji: 'ğŸ¥ ', price: 16 },
                { id: generateId(), name: 'å¯ä¹', categoryId: shopCategories[6].id, emoji: 'ğŸ¥¤', price: 8 },
                { id: generateId(), name: 'è±†æµ†', categoryId: shopCategories[6].id, emoji: 'ğŸ¥›', price: 6 }
            ];
            
            saveCategories();
            saveFoods();
            
            // Close modal and reset
            createShopModal.style.display = 'none';
            newShopName.value = '';
            
            // Re-render shop options
            renderShopOptions();
            
            showNotification(`åº—é“º "${name}" åˆ›å»ºæˆåŠŸï¼`);
        }
        
        // Show a specific page and update navigation
        function showPage(pageId) {
            console.log(`Showing page: ${pageId}, current identity: ${currentUser ? currentUser.name : 'none'}`);
            
            // Hide all pages
            [identityPage, homePage, orderPage, managementPage].forEach(page => {
                page.classList.remove('active');
            });
            
            // Show the target page
            document.getElementById(pageId).classList.add('active');
            currentPage = pageId;
            
            // Handle navigation and UI state based on page
            if (pageId === 'identityPage') {
                // Identity page - hide navigation
                globalNav.style.display = 'none';
                if (backBtnGlobal) backBtnGlobal.style.display = 'none';
            } else {
                // Other pages - show navigation and back buttons
                globalNav.style.display = 'flex';
                if (backBtnGlobal) backBtnGlobal.style.display = 'flex';
                
                if (pageId === 'homePage') {
                    if (backBtnGlobal) {
                        backBtnGlobal.textContent = 'ğŸ‘¤';
                        backBtnGlobal.style.display = 'flex';
                    }
                    if (backBtnGlobalOrder) backBtnGlobalOrder.style.display = 'none';
                    if (backBtnGlobalManagement) backBtnGlobalManagement.style.display = 'none';
                } else if (pageId === 'orderPage') {
                    if (backBtnGlobal) backBtnGlobal.style.display = 'none';
                    if (backBtnGlobalOrder) backBtnGlobalOrder.style.display = 'flex';
                    if (backBtnGlobalManagement) backBtnGlobalManagement.style.display = 'none';
                } else if (pageId === 'managementPage') {
                    if (backBtnGlobal) backBtnGlobal.style.display = 'none';
                    if (backBtnGlobalOrder) backBtnGlobalOrder.style.display = 'none';
                    if (backBtnGlobalManagement) backBtnGlobalManagement.style.display = 'flex';
                    renderManagementPage();
                }
            }
            
            // Update navigation UI
            updateNavigationUI();
        }
        
        // Update navigation UI based on current page
        function updateNavigationUI() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === currentPage);
            });
            
            // Show/hide order tab based on context
            orderNavTab.style.display = currentPage === 'orderPage' ? 'flex' : 'none';
        }
        
        // Render management page
        function renderManagementPage() {
            if (!currentUser) return;
            
            // Render identities
            identityManagementList.innerHTML = '';
            identities.forEach(identity => {
                const identityItem = document.createElement('div');
                identityItem.className = 'management-item';
                identityItem.innerHTML = `
                    <div class="item-info">
                        <div class="item-icon" style="background-color: ${identity.color};">
                            ${identity.name.charAt(0)}
                        </div>
                        <div class="item-details">
                            <div class="item-name">${identity.name}</div>
                            <div class="item-meta">${identity.id}</div>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn edit-btn" data-id="${identity.id}" data-type="identity">ç¼–è¾‘</button>
                        <button class="action-btn delete-btn" data-id="${identity.id}" data-type="identity">åˆ é™¤</button>
                    </div>
                `;
                identityManagementList.appendChild(identityItem);
            });
            
            // Render shops
            shopManagementList.innerHTML = '';
            shops.forEach(shop => {
                const shopItem = document.createElement('div');
                shopItem.className = 'management-item';
                shopItem.innerHTML = `
                    <div class="item-info">
                        <div class="item-icon" style="background-color: ${shop.color};">
                            ${shop.name.charAt(0)}
                        </div>
                        <div class="item-details">
                            <div class="item-name">${shop.name}</div>
                            <div class="item-meta">${shop.id}</div>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn edit-btn" data-id="${shop.id}" data-type="shop">ç¼–è¾‘</button>
                        <button class="action-btn delete-btn" data-id="${shop.id}" data-type="shop">åˆ é™¤</button>
                    </div>
                `;
                shopManagementList.appendChild(shopItem);
            });
            
            // Render foods
            foodManagementList.innerHTML = '';
            if (currentShopId) {
                const shopFoods = foods[currentShopId] || [];
                shopFoods.forEach(food => {
                    const foodItem = document.createElement('div');
                    foodItem.className = 'management-item';
                    foodItem.innerHTML = `
                        <div class="item-info">
                            <div class="item-icon">
                                ${food.emoji}
                            </div>
                            <div class="item-details">
                                <div class="item-name">${food.name}</div>
                                <div class="item-meta">${food.price}ç§¯åˆ†</div>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="action-btn edit-btn" data-id="${food.id}" data-type="food">ç¼–è¾‘</button>
                            <button class="action-btn delete-btn" data-id="${food.id}" data-type="food">åˆ é™¤</button>
                        </div>
                    `;
                    foodManagementList.appendChild(foodItem);
                });
            }
            
            // Render bindings summary
            bindingManagementList.innerHTML = '';
            const boundShopsCount = bindings[currentUserId] ? bindings[currentUserId].length : 0;
            const bindingItem = document.createElement('div');
            bindingItem.className = 'management-item';
            bindingItem.innerHTML = `
                <div class="item-info">
                    <div class="item-icon" style="background-color: var(--success);">
                        ğŸ””
                    </div>
                    <div class="item-details">
                        <div class="item-name">åº—é“ºç»‘å®š</div>
                        <div class="item-meta">å·²ç»‘å®š ${boundShopsCount} ä¸ªåº—é“º</div>
                    </div>
                </div>
                <div class="item-actions">
                    <button class="action-btn bind-btn" id="manageBindingsBtnInList">ç®¡ç†</button>
                </div>
            `;
            bindingManagementList.appendChild(bindingItem);
            
            // Add event listeners to management buttons
            addManagementEventListeners();
        }
        
        // Add event listeners to management buttons
        function addManagementEventListeners() {
            // Edit buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.dataset.id;
                    const type = this.dataset.type;
                    showEditModal(type, id);
                });
            });
            
            // Delete buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.dataset.id;
                    const type = this.dataset.type;
                    deleteItem(type, id);
                });
            });
            
            // Bindings management button
            const manageBindingsBtnInList = document.getElementById('manageBindingsBtnInList');
            if (manageBindingsBtnInList) {
                manageBindingsBtnInList.addEventListener('click', showBindingModal);
            }
        }
        
        // Show edit modal for items
        function showEditModal(type, id) {
            // For demo purposes, we'll just show a notification
            showNotification(`${type}ç¼–è¾‘åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®Œå–„`);
        }
        
        // Delete item from management
        function deleteItem(type, id) {
            let itemName = '';
            
            if (type === 'identity') {
                const identity = identities.find(i => i.id === id);
                if (!identity) return;
                
                itemName = identity.name;
                
                if (confirm(`ç¡®å®šè¦åˆ é™¤èº«ä»½ "${itemName}" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`)) {
                    // Remove from identities
                    identities = identities.filter(i => i.id !== id);
                    saveIdentities();
                    
                    // Remove from bindings
                    delete bindings[id];
                    saveBindings();
                    
                    showNotification(`èº«ä»½ "${itemName}" å·²åˆ é™¤`);
                    renderManagementPage();
                }
            } else if (type === 'shop') {
                const shop = shops.find(s => s.id === id);
                if (!shop) return;
                
                itemName = shop.name;
                
                if (confirm(`ç¡®å®šè¦åˆ é™¤åº—é“º "${itemName}" å—ï¼Ÿæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰ç›¸å…³æ•°æ®å’Œç»‘å®šï¼Œæ— æ³•æ’¤é”€ï¼`)) {
                    // Remove from shops
                    shops = shops.filter(s => s.id !== id);
                    saveShops();
                    
                    // Remove from categories and foods
                    delete categories[id];
                    delete foods[id];
                    saveCategories();
                    saveFoods();
                    
                    // Remove from bindings for all identities
                    Object.keys(bindings).forEach(identityId => {
                        bindings[identityId] = bindings[identityId].filter(shopId => shopId !== id);
                    });
                    saveBindings();
                    
                    // If current shop is deleted, go to shop selection
                    if (currentShopId === id) {
                        currentShopId = null;
                        currentShop = null;
                        showShopModal();
                    }
                    
                    showNotification(`åº—é“º "${itemName}" å·²åˆ é™¤`);
                    renderManagementPage();
                }
            } else if (type === 'food') {
                // Find the food item
                let foodItem = null;
                let shopId = null;
                
                for (const [sId, shopFoods] of Object.entries(foods)) {
                    foodItem = shopFoods.find(f => f.id === id);
                    if (foodItem) {
                        shopId = sId;
                        break;
                    }
                }
                
                if (!foodItem) return;
                
                itemName = foodItem.name;
                
                if (confirm(`ç¡®å®šè¦åˆ é™¤èœå“ "${itemName}" å—ï¼Ÿ`)) {
                    // Remove from foods
                    foods[shopId] = foods[shopId].filter(f => f.id !== id);
                    saveFoods();
                    
                    showNotification(`èœå“ "${itemName}" å·²åˆ é™¤`);
                    renderManagementPage();
                }
            }
        }
        
        // Show binding modal
        function showBindingModal() {
            bindingList.innerHTML = '';
            
            shops.forEach(shop => {
                const isBound = bindings[currentUserId] ? bindings[currentUserId].includes(shop.id) : false;
                
                const bindingItem = document.createElement('div');
                bindingItem.className = 'binding-item';
                bindingItem.innerHTML = `
                    <div class="binding-info">
                        <div class="binding-checkbox ${isBound ? 'checked' : ''}" data-shop-id="${shop.id}">
                            ${isBound ? 'âœ“' : ''}
                        </div>
                        <div class="shop-icon" style="background-color: ${shop.color};">
                            ${shop.name.charAt(0)}
                        </div>
                        <div>${shop.name}</div>
                    </div>
                    <div class="binding-status">
                        ${isBound ? 'å·²ç»‘å®š' : 'æœªç»‘å®š'}
                    </div>
                `;
                bindingList.appendChild(bindingItem);
            });
            
            // Add click listeners to checkboxes
            document.querySelectorAll('.binding-checkbox').forEach(checkbox => {
                checkbox.addEventListener('click', function() {
                    this.classList.toggle('checked');
                    this.innerHTML = this.classList.contains('checked') ? 'âœ“' : '';
                    
                    // Update status text
                    const statusElem = this.closest('.binding-item').querySelector('.binding-status');
                    statusElem.textContent = this.classList.contains('checked') ? 'å·²ç»‘å®š' : 'æœªç»‘å®š';
                });
            });
            
            bindingModal.style.display = 'flex';
        }
        
        // Save binding settings
        function saveBindingSettings() {
            if (!currentUserId) return;
            
            const selectedShopIds = [];
            document.querySelectorAll('.binding-checkbox.checked').forEach(checkbox => {
                selectedShopIds.push(checkbox.dataset.shopId);
            });
            
            bindings[currentUserId] = selectedShopIds;
            saveBindings();
            
            bindingModal.style.display = 'none';
            showNotification(`ç»‘å®šè®¾ç½®å·²ä¿å­˜ï¼å·²ç»‘å®š ${selectedShopIds.length} ä¸ªåº—é“º`);
            
            // Update management page
            renderManagementPage();
        }
        
        // Setup event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Identity page events
            createIdentityBtn.addEventListener('click', createIdentity);
            cancelNewIdentityBtn.addEventListener('click', function() {
                newIdentityForm.style.display = 'none';
                newIdentityName.value = '';
            });
            
            // Shop modal events
            cancelShopBtn.addEventListener('click', hideShopModal);
            createShopBtn.addEventListener('click', function() {
                hideShopModal();
                createShopModal.style.display = 'flex';
            });
            
            // Create shop modal events
            cancelCreateShopBtn.addEventListener('click', function() {
                createShopModal.style.display = 'none';
                newShopName.value = '';
            });
            
            confirmCreateShopBtn.addEventListener('click', createShop);
            
            // Change shop button
            changeShopBtn.addEventListener('click', function() {
                showShopModal();
            });
            
            // Meal tab clicks
            mealTabs.addEventListener('click', function(e) {
                const tab = e.target.closest('.meal-tab');
                if (tab) {
                    currentMealType = tab.dataset.meal;
                    showOrderPage();
                }
            });
            
            // Food selection events
            clearSelectionBtn.addEventListener('click', function() {
                if (selectedFoods.length > 0 && confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é€‰æ‹©å—ï¼Ÿ')) {
                    selectedFoods = [];
                    updateSelectedItemsDisplay();
                    renderCategories();
                    showNotification('å·²æ¸…ç©ºæ‰€æœ‰é€‰æ‹©');
                }
            });
            
            submitOrderBtn.addEventListener('click', submitOrder);
            
            // Global navigation
            globalNav.addEventListener('click', function(e) {
                const navItem = e.target.closest('.nav-item');
                if (navItem) {
                    const page = navItem.dataset.page;
                    if (page === 'orderPage' && !currentMealType) {
                        showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¤é£Ÿ');
                        return;
                    }
                    showPage(page);
                }
            });
            
            // Reset data
            resetAllDataBtn.addEventListener('click', function() {
                if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰èº«ä»½ã€åº—é“ºå’Œç‚¹é¤è®°å½•ï¼Œä¸”æ— æ³•æ¢å¤ï¼')) {
                    localStorage.clear();
                    location.reload();
                }
            });
            
            // Management page buttons
            addIdentityBtn.addEventListener('click', function() {
                toggleNewIdentityForm();
                showPage('identityPage');
            });
            
            addShopBtn.addEventListener('click', function() {
                createShopModal.style.display = 'flex';
            });
            
            addFoodBtn.addEventListener('click', function() {
                showNotification('æ·»åŠ èœå“åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®Œå–„');
            });
            
            manageBindingsBtn.addEventListener('click', showBindingModal);
            
            // Binding modal events
            cancelBindingBtn.addEventListener('click', function() {
                bindingModal.style.display = 'none';
            });
            
            saveBindingBtn.addEventListener('click', saveBindingSettings);
            
            exportDataBtn.addEventListener('click', function() {
                showNotification('å¯¼å‡ºæ•°æ®åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®Œå–„');
            });
            
            importDataBtn.addEventListener('click', function() {
                showNotification('å¯¼å…¥æ•°æ®åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®Œå–„');
            });
            
            console.log('Event listeners setup completed');
        }
        
        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // Get random color for new identities/shops
        function getRandomColor() {
            const colors = ['#4facfe', '#ff6b6b', '#43e97b', '#f9d423', '#ff9a9e', '#a18cd1', '#fad0c4'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // Save data to localStorage
        function saveIdentities() {
            localStorage.setItem('identities', JSON.stringify(identities));
        }
        
        function saveShops() {
            localStorage.setItem('shops', JSON.stringify(shops));
        }
        
        function saveCategories() {
            localStorage.setItem('categories', JSON.stringify(categories));
        }
        
        function saveFoods() {
            localStorage.setItem('foods', JSON.stringify(foods));
        }
        
        function saveOrders() {
            localStorage.setItem('orders', JSON.stringify(orders));
        }
        
        function saveBindings() {
            localStorage.setItem('bindings', JSON.stringify(bindings));
        }
        
        // Show in-app notification
        function showNotification(message, type = 'info') {
            notification.textContent = message;
            notification.className = 'notification';
            
            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #4caf50, #43a047)';
            } else if (type === 'error') {
                notification.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a24)';
            } else {
                notification.style.background = 'linear-gradient(135deg, var(--primary), var(--secondary))';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing application...');
            initApp();
        });
    </script>
</body>
</html>